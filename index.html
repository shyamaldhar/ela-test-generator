<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELA Test Generator - Unlimited Tests with AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .control-panel h1 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 28px;
        }

        .feature-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .generate-btn {
            background: #667eea;
            color: white;
        }

        .generate-btn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .print-btn {
            background: #48bb78;
            color: white;
        }

        .print-btn:hover:not(:disabled) {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .answer-key-btn {
            background: #ed8936;
            color: white;
        }

        .answer-key-btn:hover:not(:disabled) {
            background: #dd6b20;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(237, 137, 54, 0.4);
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .mode-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .mode-option:hover {
            border-color: #667eea;
            background: white;
        }

        .mode-option.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .mode-option h3 {
            margin-bottom: 5px;
            font-size: 16px;
        }

        .mode-option p {
            font-size: 12px;
            opacity: 0.8;
        }

        .test-paper {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .test-header {
            text-align: center;
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .test-header h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .test-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 14px;
            color: #4a5568;
        }

        .info-line {
            border-bottom: 1px solid #cbd5e0;
            display: inline-block;
            min-width: 200px;
        }

        .section {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }

        .section-header {
            background: #667eea;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .passage-box {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 25px;
            line-height: 1.8;
            font-size: 15px;
        }

        .passage-title {
            font-weight: bold;
            font-size: 18px;
            color: #2d3748;
            margin-bottom: 15px;
            text-align: center;
        }

        .question {
            margin-bottom: 30px;
            page-break-inside: avoid;
        }

        .question-number {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .question-text {
            color: #2d3748;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .options {
            margin-left: 20px;
        }

        .option {
            margin-bottom: 8px;
            font-size: 14px;
            color: #4a5568;
        }

        .writing-space {
            margin-top: 10px;
            border: 1px solid #cbd5e0;
            min-height: 80px;
            padding: 10px;
            background: white;
        }

        .writing-lines {
            background-image: repeating-linear-gradient(
                transparent,
                transparent 27px,
                #e2e8f0 27px,
                #e2e8f0 28px
            );
            min-height: 80px;
            padding: 10px;
        }

        .answer-key {
            background: #fff5f5;
            border: 2px solid #fc8181;
            padding: 30px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .answer-key h2 {
            color: #c53030;
            margin-bottom: 20px;
            text-align: center;
        }

        .answer-section {
            margin-bottom: 25px;
        }

        .answer-section h3 {
            color: #2d3748;
            margin-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 5px;
        }

        .answer-item {
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 5px;
        }

        .answer-number {
            font-weight: bold;
            color: #667eea;
        }

        .correct-answer {
            color: #38a169;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 60px 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .loading h2 {
            color: #667eea;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .loading p {
            color: #4a5568;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .instructions {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #2d3748;
        }

        .vocab-word {
            font-weight: bold;
            color: #667eea;
        }

        .info-box {
            background: #e6fffa;
            border-left: 4px solid #38b2ac;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .info-box strong {
            color: #234e52;
        }

        /* Interactive Answer Input Styles */
        .answer-input {
            width: 100%;
            max-width: 150px;
            padding: 8px 12px;
            margin-top: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .answer-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .answer-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            margin-top: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.6;
        }

        .answer-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .submit-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-top: 30px;
            text-align: center;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 40px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Feedback Display Styles */
        .feedback-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .score-summary {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .score-summary h2 {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .score-summary .letter-grade {
            font-size: 72px;
            font-weight: bold;
            margin: 20px 0;
        }

        .section-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .section-score-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section-score-card h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .section-score-card .score {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .question-feedback {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #cbd5e0;
        }

        .question-feedback.correct {
            background: #f0fdf4;
            border-left-color: #22c55e;
        }

        .question-feedback.incorrect {
            background: #fef2f2;
            border-left-color: #ef4444;
        }

        .question-feedback.partial {
            background: #fffbeb;
            border-left-color: #f59e0b;
        }

        .feedback-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .feedback-icon {
            font-size: 24px;
        }

        .feedback-title {
            font-size: 18px;
            font-weight: bold;
            color: #2d3748;
        }

        .feedback-content {
            margin-top: 15px;
        }

        .feedback-section {
            margin-bottom: 15px;
        }

        .feedback-section h4 {
            color: #4a5568;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .feedback-section p {
            color: #2d3748;
            line-height: 1.6;
        }

        .overall-feedback {
            background: #edf2f7;
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .overall-feedback h3 {
            color: #2d3748;
            margin-bottom: 15px;
        }

        .overall-feedback ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .overall-feedback li {
            margin-bottom: 8px;
            color: #4a5568;
            line-height: 1.6;
        }

        .mode-toggle {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .mode-toggle label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            font-weight: bold;
            color: #2d3748;
        }

        .mode-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .control-panel {
                display: none;
            }

            .test-paper {
                box-shadow: none;
                padding: 20px;
            }

            .answer-key {
                page-break-before: always;
            }

            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="control-panel no-print">
            <h1>📚 ELA Test Generator <span class="feature-badge">AI-POWERED</span></h1>
            <p style="margin-bottom: 15px; color: #4a5568;">Generate unlimited unique tests for 7th-8th grade students covering Plot Elements, Poetry Analysis, and Vocabulary</p>
            
            <div class="mode-selector">
                <div class="mode-option active" onclick="setMode('preset')" id="presetMode">
                    <h3>⚡ Quick Mode</h3>
                    <p>Use pre-loaded content (instant)</p>
                </div>
                <div class="mode-option" onclick="setMode('ai')" id="aiMode">
                    <h3>🤖 AI Mode</h3>
                    <p>Generate unique content with AI</p>
                </div>
            </div>

            <div class="info-box">
                <strong>💡 Quick Mode:</strong> Uses 3 rotating pre-written passages for instant test generation<br>
                <strong>🚀 AI Mode:</strong> Creates completely unique stories, poems, and vocabulary every time (requires Claude API)
            </div>

            <div class="mode-toggle">
                <label>
                    <input type="checkbox" id="interactiveToggle" onchange="toggleInteractiveMode()">
                    <span>🎓 Interactive Mode - Students can type answers and get AI feedback</span>
                </label>
            </div>

            <div class="button-group">
                <button class="generate-btn" onclick="generateTest()" id="generateBtn">🔄 Generate New Test</button>
                <button class="print-btn" onclick="printTest()">🖨️ Print Test</button>
                <button class="answer-key-btn" onclick="toggleAnswerKey()">📋 Show Answer Key</button>
            </div>
        </div>

        <div id="testContent"></div>
    </div>

    <script>
        let currentMode = 'preset';
        let currentTest = null;
        let showAnswerKey = false;
        let interactiveMode = false; // New: Track if in interactive mode
        let studentAnswers = {}; // New: Store student answers

        // Sample data pools for preset mode
        const storyPassages = [
            {
                title: "The Last Game",
                text: `Marcus had dreamed of playing varsity basketball since sixth grade. Now, as a senior, he finally made the team. However, during the championship game, with only thirty seconds left and his team down by two points, Coach Henderson benched him in favor of Jake, the team's star player. Marcus felt his chest tighten as he watched from the sidelines.

The crowd roared as Jake dribbled down the court. Marcus clenched his fists, torn between wanting his team to win and feeling bitter about being sidelined at such a crucial moment. Time seemed to slow as Jake drove toward the basket.

Suddenly, Jake stumbled and lost the ball. It rolled directly toward the sideline where Marcus stood. Without thinking, Marcus lunged forward, caught the ball just before it went out of bounds, and in one fluid motion, passed it to Jake, who had recovered his footing.

Jake caught the pass, took the shot, and scored. The buzzer sounded. They had won. As his teammates celebrated, Coach Henderson pulled Marcus aside. "That was the most important play of the game," he said. "You put the team first when it mattered most."

Marcus smiled, realizing that sometimes the most significant moments don't come from the spotlight but from choosing to do what's right.`,
                exposition: "Marcus finally made varsity basketball as a senior after years of dreaming about it.",
                conflict: "Marcus is benched during the championship game's crucial final moments in favor of Jake.",
                risingAction: "Marcus watches anxiously as Jake dribbles down the court, feeling conflicted about his emotions.",
                climax: "Jake loses the ball, and it rolls toward Marcus on the sideline.",
                fallingAction: "Marcus catches the ball and passes it to Jake, who scores the winning basket.",
                resolution: "Coach Henderson praises Marcus for putting the team first, and Marcus learns about true sportsmanship."
            },
            {
                title: "The Science Project",
                text: `Mia and her best friend Rachel had been partners on every science project since third grade. They worked together perfectly: Mia loved research and writing, while Rachel excelled at presentations and visual design. This year's project could earn them a spot in the state competition.

Two weeks before the deadline, Rachel's family announced they were moving to another state immediately. Rachel promised to finish her half of the project remotely, but days passed with no response to Mia's messages. The presentation boards remained blank, and Mia's carefully researched report meant nothing without the visual component.

Panic set in. Mia stayed up late trying to learn design software, creating awkward diagrams that looked nothing like Rachel's usual work. She felt betrayed and overwhelmed, questioning whether she should even submit the project.

The night before the deadline, a package arrived at Mia's door. Inside were stunning presentation boards, perfectly designed, with a note from Rachel: "I'm sorry for going silent. Moving was harder than I expected, but I couldn't let you down. We're still a team."

Mia carefully assembled the project, combining her research with Rachel's designs. They didn't win first place, but they made it to the state competition. More importantly, Mia learned that true friendship endures even across distances.`,
                exposition: "Mia and Rachel have been science project partners since third grade, and this year's project is important.",
                conflict: "Rachel moves away suddenly, leaving Mia to complete the project alone with the deadline approaching.",
                risingAction: "Days pass with no response from Rachel, and Mia struggles to create the visual components herself.",
                climax: "A package from Rachel arrives the night before the deadline.",
                fallingAction: "Mia discovers Rachel completed her part despite the move and assembles the project.",
                resolution: "They reach the state competition and Mia learns about the endurance of true friendship."
            },
            {
                title: "The Audition",
                text: `Every year, Lincoln Middle School produced one major musical, and every year, Emma attended auditions hoping for a lead role. After three years of being cast in the chorus, this was her final chance before high school. She had practiced her audition song hundreds of times.

The audition day arrived, and Emma's hands trembled as she signed in. She watched other students perform, each one seemingly more talented than the last. When her name was called, Emma walked onto the stage, trying to appear confident despite her racing heart.

She opened her mouth to sing, but no sound came out. Her mind went blank. The piano played the introduction again, giving her another chance. Still nothing. Emma's face flushed red as she mumbled an apology and rushed off the stage, tears streaming down her face.

In the hallway, Mrs. Chen, the drama teacher, found her. "Emma, I've watched you work hard for three years. That wasn't a lack of talent—it was nerves. I have a proposal." Mrs. Chen explained that she needed an assistant director to help with blocking and choreography, someone who understood the production from every angle.

Emma accepted, and as she worked behind the scenes, she discovered a passion for directing. On opening night, watching the show she'd helped create, Emma realized that sometimes our greatest disappointments lead us to discover where we truly belong.`,
                exposition: "Emma has auditioned for lead roles in school musicals for three years, always ending up in the chorus.",
                conflict: "During her final audition chance, Emma freezes on stage and cannot sing.",
                risingAction: "Emma rushes off stage in tears, feeling humiliated and defeated.",
                climax: "Mrs. Chen finds Emma in the hallway and offers her a different opportunity.",
                fallingAction: "Emma accepts the assistant director position and discovers a passion for directing.",
                resolution: "Emma realizes on opening night that her disappointment led her to discover her true calling."
            }
        ];

        const poems = [
            {
                title: "The Road Not Taken (Excerpt)",
                author: "Robert Frost",
                text: `Two roads diverged in a yellow wood,
And sorry I could not travel both
And be one traveler, long I stood
And looked down one as far as I could
To where it bent in the undergrowth;

Then took the other, as just as fair,
And having perhaps the better claim,
Because it was grassy and wanted wear;
Though as for that the passing there
Had worn them really about the same,`,
                theme: "Choices and their consequences",
                mood: "Reflective and contemplative",
                tone: "Thoughtful and slightly nostalgic",
                structure: "Two stanzas of five lines each, with ABAAB rhyme scheme"
            },
            {
                title: "Dreams",
                author: "Langston Hughes",
                text: `Hold fast to dreams
For if dreams die
Life is a broken-winged bird
That cannot fly.

Hold fast to dreams
For when dreams go
Life is a barren field
Frozen with snow.`,
                theme: "The importance of holding onto dreams and aspirations",
                mood: "Urgent and cautionary",
                tone: "Direct and imperative",
                structure: "Two quatrains with simple ABCB rhyme scheme"
            },
            {
                title: "Stopping by Woods on a Snowy Evening (Excerpt)",
                author: "Robert Frost",
                text: `Whose woods these are I think I know.
His house is in the village though;
He will not see me stopping here
To watch his woods fill up with snow.

My little horse must think it queer
To stop without a farmhouse near
Between the woods and frozen lake
The darkest evening of the year.`,
                theme: "Temptation vs. responsibility; beauty of nature vs. obligations",
                mood: "Peaceful yet contemplative",
                tone: "Quiet and reflective",
                structure: "Two quatrains with AABA rhyme scheme"
            }
        ];

        const vocabularyWords = [
            {
                word: "resilient",
                definition: "able to recover quickly from difficulties; tough",
                synonyms: ["flexible", "adaptable", "strong"],
                antonyms: ["weak", "fragile", "brittle"],
                sentence: "Despite failing the test, Maria remained _______ and studied harder for the next one.",
                prefix: "re- (meaning: again)",
                context: "The _______ community rebuilt their town after the devastating flood."
            },
            {
                word: "benevolent",
                definition: "well-meaning and kindly",
                synonyms: ["kind", "generous", "charitable"],
                antonyms: ["malevolent", "cruel", "mean"],
                sentence: "The _______ teacher stayed after school to help struggling students.",
                prefix: "bene- (meaning: good, well)",
                context: "Her _______ actions made everyone feel welcome in the new school."
            },
            {
                word: "ambiguous",
                definition: "open to more than one interpretation; unclear",
                synonyms: ["vague", "unclear", "uncertain"],
                antonyms: ["clear", "obvious", "explicit"],
                sentence: "The ending of the story was _______, leaving readers to draw their own conclusions.",
                prefix: "ambi- (meaning: both)",
                context: "His _______ response made it impossible to know if he agreed or disagreed."
            },
            {
                word: "meticulous",
                definition: "showing great attention to detail; very careful",
                synonyms: ["thorough", "precise", "careful"],
                antonyms: ["careless", "sloppy", "hasty"],
                sentence: "The artist was _______ in her work, spending hours on tiny details.",
                prefix: "None",
                context: "Her _______ planning ensured the event ran smoothly without problems."
            },
            {
                word: "eloquent",
                definition: "fluent and persuasive in speaking or writing",
                synonyms: ["articulate", "expressive", "persuasive"],
                antonyms: ["inarticulate", "tongue-tied", "unclear"],
                sentence: "The _______ speech moved the audience to tears.",
                prefix: "e- (meaning: out)",
                context: "His _______ argument convinced everyone to support the proposal."
            },
            {
                word: "inherent",
                definition: "existing as a natural or permanent part of something",
                synonyms: ["intrinsic", "natural", "innate"],
                antonyms: ["acquired", "learned", "external"],
                sentence: "There is an _______ risk in any adventure sport.",
                prefix: "in- (meaning: in)",
                context: "Curiosity is an _______ quality in young children."
            },
            {
                word: "scrutinize",
                definition: "to examine or inspect closely and thoroughly",
                synonyms: ["examine", "inspect", "analyze"],
                antonyms: ["ignore", "overlook", "neglect"],
                sentence: "The detective began to _______ every detail of the crime scene.",
                prefix: "None",
                context: "Scientists _______ the data before publishing their findings."
            },
            {
                word: "tedious",
                definition: "too long, slow, or dull; tiresome or monotonous",
                synonyms: ["boring", "monotonous", "dull"],
                antonyms: ["exciting", "interesting", "engaging"],
                sentence: "Copying all the notes by hand was a _______ task.",
                prefix: "None",
                context: "The _______ lecture made it difficult for students to stay focused."
            },
            {
                word: "skeptical",
                definition: "not easily convinced; having doubts",
                synonyms: ["doubtful", "questioning", "suspicious"],
                antonyms: ["trusting", "believing", "credulous"],
                sentence: "She was _______ of the advertisement's claims about the product.",
                prefix: "None",
                context: "The _______ scientist demanded more evidence before accepting the theory."
            },
            {
                word: "spontaneous",
                definition: "performed without planning or external cause",
                synonyms: ["impromptu", "unplanned", "impulsive"],
                antonyms: ["planned", "deliberate", "calculated"],
                sentence: "Their _______ decision to take a road trip led to an unforgettable adventure.",
                prefix: "None",
                context: "The crowd's _______ applause showed their genuine appreciation."
            },
            {
                word: "adversity",
                definition: "difficulties or misfortune",
                synonyms: ["hardship", "difficulty", "misfortune"],
                antonyms: ["prosperity", "fortune", "success"],
                sentence: "The team showed great courage in the face of _______.",
                prefix: "None",
                context: "She overcame many instances of _______ to achieve her goals."
            },
            {
                word: "comprehend",
                definition: "to understand fully",
                synonyms: ["understand", "grasp", "fathom"],
                antonyms: ["misunderstand", "confuse", "misinterpret"],
                sentence: "It took several readings before I could _______ the complex theory.",
                prefix: "com- (meaning: together, with)",
                context: "Young students may struggle to _______ abstract concepts."
            },
            {
                word: "diligent",
                definition: "having or showing care and conscientiousness",
                synonyms: ["hardworking", "industrious", "conscientious"],
                antonyms: ["lazy", "careless", "negligent"],
                sentence: "Her _______ study habits resulted in excellent grades.",
                prefix: "None",
                context: "The _______ worker never missed a deadline."
            },
            {
                word: "illuminate",
                definition: "to light up; to clarify or explain",
                synonyms: ["brighten", "clarify", "enlighten"],
                antonyms: ["darken", "obscure", "confuse"],
                sentence: "The teacher's examples helped to _______ the difficult concept.",
                prefix: "il- (meaning: in, into)",
                context: "The documentary sought to _______ the history of the civil rights movement."
            },
            {
                word: "persevere",
                definition: "to continue despite difficulty",
                synonyms: ["persist", "endure", "continue"],
                antonyms: ["quit", "surrender", "give up"],
                sentence: "You must _______ through challenges to achieve your goals.",
                prefix: "per- (meaning: through, thoroughly)",
                context: "Athletes must _______ through pain and exhaustion during training."
            }
        ];

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('presetMode').classList.toggle('active', mode === 'preset');
            document.getElementById('aiMode').classList.toggle('active', mode === 'ai');
        }

        async function generateTest() {
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = currentMode === 'ai' ? '⏳ Generating with AI...' : '⏳ Generating...';

            if (currentMode === 'ai') {
                await generateAITest();
            } else {
                generatePresetTest();
            }

            generateBtn.disabled = false;
            generateBtn.textContent = '🔄 Generate New Test';
        }

        function generatePresetTest() {
            // Randomly select content
            const story = storyPassages[Math.floor(Math.random() * storyPassages.length)];
            const poem = poems[Math.floor(Math.random() * poems.length)];
            
            // Randomly select 12 vocabulary words
            const shuffledVocab = [...vocabularyWords].sort(() => Math.random() - 0.5);
            const selectedVocab = shuffledVocab.slice(0, 12);

            currentTest = {
                story,
                poem,
                vocabulary: selectedVocab,
                answers: {
                    plotElements: {},
                    poetry: {},
                    vocabulary: {}
                }
            };

            renderTest();
        }

        async function generateAITest() {
            // Show loading state
            document.getElementById('testContent').innerHTML = `
                <div class="loading">
                    <h2>🤖 AI is creating your unique test...</h2>
                    <p>Generating a custom story, poem, and vocabulary exercises</p>
                    <div class="spinner"></div>
                    <p style="margin-top: 20px; font-size: 14px; color: #718096;">This takes about 30-60 seconds</p>
                </div>
            `;

            try {
                // Generate story via serverless function
                const storyResponse = await fetch("/api/generate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ type: "story" })
                });

                if (!storyResponse.ok) {
                    const errorData = await storyResponse.json();
                    throw new Error(`Story generation failed: ${errorData.error || 'Unknown error'}`);
                }
                
                const storyResult = await storyResponse.json();
                const storyJson = storyResult.data;

                // Generate poem via serverless function
                const poemResponse = await fetch("/api/generate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ type: "poem" })
                });

                if (!poemResponse.ok) {
                    const errorData = await poemResponse.json();
                    throw new Error(`Poem generation failed: ${errorData.error || 'Unknown error'}`);
                }
                
                const poemResult = await poemResponse.json();
                const poemJson = poemResult.data;

                // Generate vocabulary via serverless function
                const vocabResponse = await fetch("/api/generate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ type: "vocabulary" })
                });

                if (!vocabResponse.ok) {
                    const errorData = await vocabResponse.json();
                    throw new Error(`Vocabulary generation failed: ${errorData.error || 'Unknown error'}`);
                }
                
                const vocabResult = await vocabResponse.json();
                const vocabJson = vocabResult.data;

                // Create test with AI-generated content
                currentTest = {
                    story: storyJson,
                    poem: poemJson,
                    vocabulary: vocabJson,
                    answers: {
                        plotElements: {},
                        poetry: {},
                        vocabulary: {}
                    }
                };

                renderTest();

            } catch (error) {
                console.error('AI generation error:', error);
                document.getElementById('testContent').innerHTML = `
                    <div class="loading">
                        <h2 style="color: #e53e3e;">❌ Error Generating AI Test</h2>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p style="margin-top: 15px;">Make sure you've deployed to Vercel and set your API key.</p>
                        <p style="margin-top: 20px;"><strong>Switching to Quick Mode...</strong></p>
                        <p style="font-size: 14px; color: #718096; margin-top: 10px;">Quick Mode still generates randomized tests from pre-written content!</p>
                    </div>
                `;
                setTimeout(() => {
                    setMode('preset');
                    generatePresetTest();
                }, 3000);
            }
        }

        function renderTest() {
            const testDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            const answerKeyButtonText = showAnswerKey ? '🔒 Hide Answer Key' : '📋 Show Answer Key';

            let html = `
                <div class="test-paper">
                    <div class="test-header">
                        <h1>ELA Assessment Test</h1>
                        <p style="font-size: 16px; color: #4a5568;">Grades 7-8 | Duration: 30 minutes</p>
                        <div class="test-info">
                            <div>
                                <strong>Name:</strong> <span class="info-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                            </div>
                            <div>
                                <strong>Date:</strong> <span class="info-line">${testDate}</span>
                            </div>
                            <div>
                                <strong>Class:</strong> <span class="info-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                            </div>
                        </div>
                    </div>

                    <div class="instructions">
                        <strong>Instructions:</strong> Read all passages and questions carefully. For multiple-choice questions, circle the best answer. For short-answer questions, write your response in the space provided. Use the back of the page if you need more room.
                    </div>

                    ${renderPlotElementsSection()}
                    ${renderPoetrySection()}
                    ${renderVocabularySection()}
                </div>

            ${interactiveMode && !showAnswerKey ? `
                <div class="submit-section no-print">
                    <h2 style="color: #2d3748; margin-bottom: 15px;">✅ Ready to Submit?</h2>
                    <p style="color: #4a5568; margin-bottom: 20px;">
                        Make sure you've answered all questions. Your answers are auto-saved as you type!
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="submit-btn" onclick="submitForAnalysis()">
                            🤖 Submit for AI Analysis
                        </button>
                        <button onclick="clearAnswers()" 
                                style="padding: 12px 24px; background: #e53e3e; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            🗑️ Clear All Answers
                        </button>
                    </div>
                    <p style="margin-top: 15px; font-size: 14px; color: #718096;">
                        💡 Cost: ~$0.03-0.04 for AI analysis • Results in 20-40 seconds
                    </p>
                    <p style="margin-top: 10px; font-size: 13px; color: #718096;">
                        Answered: <strong id="answerCount">${Object.keys(studentAnswers).length}</strong> questions
                    </p>
                </div>
            ` : ''}

                ${showAnswerKey ? renderAnswerKey() : ''}
            `;

            document.getElementById('testContent').innerHTML = html;
            
            const answerKeyBtn = document.querySelector('.answer-key-btn');
            if (answerKeyBtn) {
                answerKeyBtn.innerHTML = answerKeyButtonText;
            }
        }

        function renderPlotElementsSection() {
            const story = currentTest.story;
            
            const questions = [
                {
                    q: "Which of the following best describes the EXPOSITION of this story?",
                    options: [
                        story.exposition,
                        story.conflict,
                        story.climax,
                        story.resolution
                    ],
                    correct: 0
                },
                {
                    q: "What is the main CONFLICT in this story?",
                    options: [
                        story.exposition,
                        story.conflict,
                        story.risingAction,
                        story.fallingAction
                    ],
                    correct: 1
                },
                {
                    q: "Which event represents the CLIMAX of the story?",
                    options: [
                        story.risingAction,
                        story.conflict,
                        story.climax,
                        story.fallingAction
                    ],
                    correct: 2
                },
                {
                    q: "What happens during the FALLING ACTION?",
                    options: [
                        story.climax,
                        story.fallingAction,
                        story.exposition,
                        story.conflict
                    ],
                    correct: 1
                },
                {
                    q: "How is the conflict RESOLVED in this story?",
                    options: [
                        story.risingAction,
                        story.fallingAction,
                        story.resolution,
                        story.climax
                    ],
                    correct: 2
                }
            ];

            questions.forEach(q => {
                const correct = q.options[q.correct];
                q.options.sort(() => Math.random() - 0.5);
                q.correct = q.options.indexOf(correct);
            });

            questions.forEach((q, i) => {
                currentTest.answers.plotElements[i + 1] = String.fromCharCode(65 + q.correct);
            });

            let html = `
                <div class="section">
                    <div class="section-header">Part I: Plot Elements (6 questions)</div>
                    
                    <div class="passage-box">
                        <div class="passage-title">"${story.title}"</div>
                        ${story.text.split('\n\n').map(p => `<p style="margin-bottom: 15px;">${p}</p>`).join('')}
                    </div>

                    ${questions.map((q, i) => `
                        <div class="question">
                            <div class="question-number">Question ${i + 1}.</div>
                            <div class="question-text">${q.q}</div>
                            <div class="options">
                                ${q.options.map((opt, j) => `
                                    <div class="option">
                                        <strong>${String.fromCharCode(65 + j)}.</strong> ${opt}
                                    </div>
                                `).join('')}
                            </div>
                            ${interactiveMode ? `
                                <div style="margin-top: 12px;">
                                    <label style="font-weight: bold; color: #4a5568; font-size: 14px;">Your Answer:</label>
                                    <input type="text" 
                                           class="answer-input" 
                                           placeholder="Enter A, B, C, or D"
                                           maxlength="1"
                                           data-question="${i + 1}"
                                           value="${studentAnswers['q' + (i + 1)] || ''}"
                                           oninput="this.value = this.value.toUpperCase(); saveAnswer('q' + (i + 1), this.value)">
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}

                    <div class="question">
                        <div class="question-number">Question 6.</div>
                        <div class="question-text">In 2-3 sentences, explain how the main character changes from the beginning to the end of the story. What causes this change?</div>
                        ${interactiveMode ? `
                            <textarea class="answer-textarea" 
                                      placeholder="Type your answer here... (2-3 sentences)"
                                      data-question="6"
                                      oninput="saveAnswer('q6', this.value)">${studentAnswers['q6'] || ''}</textarea>
                        ` : '<div class="writing-lines"></div>'}
                    </div>
                </div>
            `;

            return html;
        }

        function renderPoetrySection() {
            const poem = currentTest.poem;
            
            const questions = [
                {
                    q: "What is the main THEME of this poem?",
                    options: [
                        poem.theme,
                        "The beauty of nature in springtime",
                        "The importance of friendship",
                        "Overcoming fear of the unknown"
                    ],
                    correct: 0
                },
                {
                    q: "Which word best describes the MOOD of this poem?",
                    options: [
                        "Joyful",
                        "Angry",
                        poem.mood.split(' ')[0],
                        "Frightening"
                    ],
                    correct: 2
                },
                {
                    q: "The TONE of this poem can best be described as:",
                    options: [
                        "Sarcastic and mocking",
                        poem.tone.split(' ')[0],
                        "Humorous and playful",
                        "Aggressive and demanding"
                    ],
                    correct: 1
                },
                {
                    q: "What is the STRUCTURE of this poem?",
                    options: [
                        "Free verse with no pattern",
                        "Single stanza with fourteen lines",
                        poem.structure,
                        "Three stanzas with ABAB rhyme scheme"
                    ],
                    correct: 2
                }
            ];

            questions.forEach(q => {
                const correct = q.options[q.correct];
                q.options.sort(() => Math.random() - 0.5);
                q.correct = q.options.indexOf(correct);
            });

            questions.forEach((q, i) => {
                currentTest.answers.poetry[i + 7] = String.fromCharCode(65 + q.correct);
            });

            let html = `
                <div class="section">
                    <div class="section-header">Part II: Poetry Analysis (6 questions)</div>
                    
                    <div class="passage-box">
                        <div class="passage-title">"${poem.title}"</div>
                        <div style="text-align: center; font-style: italic; margin-bottom: 15px;">by ${poem.author}</div>
                        <div style="white-space: pre-line; text-align: left; max-width: 500px; margin: 0 auto;">
${poem.text}
                        </div>
                    </div>

                    ${questions.map((q, i) => `
                        <div class="question">
                            <div class="question-number">Question ${i + 7}.</div>
                            <div class="question-text">${q.q}</div>
                            <div class="options">
                                ${q.options.map((opt, j) => `
                                    <div class="option">
                                        <strong>${String.fromCharCode(65 + j)}.</strong> ${opt}
                                    </div>
                                `).join('')}
                            </div>
                            ${interactiveMode ? `
                                <div style="margin-top: 12px;">
                                    <label style="font-weight: bold; color: #4a5568; font-size: 14px;">Your Answer:</label>
                                    <input type="text" 
                                           class="answer-input" 
                                           placeholder="Enter A, B, C, or D"
                                           maxlength="1"
                                           data-question="${i + 1}"
                                           value="${studentAnswers['q' + (i + 1)] || ''}"
                                           oninput="this.value = this.value.toUpperCase(); saveAnswer('q' + (i + 1), this.value)">
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}

                    <div class="question">
                        <div class="question-number">Question 11.</div>
                        <div class="question-text">Identify one literary device (metaphor, simile, personification, etc.) used in this poem. Write the line where it appears and explain its meaning.</div>
                        ${interactiveMode ? `
                            <textarea class="answer-textarea" 
                                      placeholder="Type your answer here..."
                                      data-question="11"
                                      oninput="saveAnswer('q11', this.value)">${studentAnswers['q11'] || ''}</textarea>
                        ` : '<div class="writing-lines"></div>'}
                    </div>

                    <div class="question">
                        <div class="question-number">Question 12.</div>
                        <div class="question-text">In your own words, explain what the poet is trying to communicate to the reader. Support your answer with evidence from the poem.</div>
                        ${interactiveMode ? `
                            <textarea class="answer-textarea" 
                                      placeholder="Type your answer here..."
                                      data-question="12"
                                      oninput="saveAnswer('q12', this.value)">${studentAnswers['q12'] || ''}</textarea>
                        ` : '<div class="writing-lines"></div>'}
                    </div>
                </div>
            `;

            return html;
        }

        function renderVocabularySection() {
            const vocab = currentTest.vocabulary;
            
            let html = `
                <div class="section">
                    <div class="section-header">Part III: Vocabulary Practice (15 questions)</div>
                    
                    <p style="margin-bottom: 20px;"><strong>Section A: Synonyms and Antonyms</strong></p>
            `;

            for (let i = 0; i < 4; i++) {
                const word = vocab[i];
                const correctSyn = word.synonyms[0];
                const options = [correctSyn, word.antonyms[0], "indifferent", "moderate"];
                const shuffled = options.sort(() => Math.random() - 0.5);
                const correctIdx = shuffled.indexOf(correctSyn);
                
                currentTest.answers.vocabulary[13 + i] = String.fromCharCode(65 + correctIdx);

                html += `
                    <div class="question">
                        <div class="question-number">Question ${13 + i}.</div>
                        <div class="question-text">Which word is a SYNONYM for <span class="vocab-word">${word.word}</span>?</div>
                        <div class="options">
                            ${shuffled.map((opt, j) => `
                                <div class="option">
                                    <strong>${String.fromCharCode(65 + j)}.</strong> ${opt}
                                </div>
                            `).join('')}
                        </div>
                        ${interactiveMode ? `
                            <div style="margin-top: 12px;">
                                <label style="font-weight: bold; color: #4a5568; font-size: 14px;">Your Answer:</label>
                                <input type="text" 
                                       class="answer-input" 
                                       placeholder="Enter A, B, C, or D"
                                       maxlength="1"
                                       data-question="${13 + i}"
                                       value="${studentAnswers['q' + (13 + i)] || ''}"
                                       oninput="this.value = this.value.toUpperCase(); saveAnswer('q' + (13 + i), this.value)">
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            for (let i = 4; i < 7; i++) {
                const word = vocab[i];
                const correctAnt = word.antonyms[0];
                const options = [word.synonyms[0], correctAnt, "neutral", "average"];
                const shuffled = options.sort(() => Math.random() - 0.5);
                const correctIdx = shuffled.indexOf(correctAnt);
                
                currentTest.answers.vocabulary[13 + i] = String.fromCharCode(65 + correctIdx);

                html += `
                    <div class="question">
                        <div class="question-number">Question ${13 + i}.</div>
                        <div class="question-text">Which word is an ANTONYM for <span class="vocab-word">${word.word}</span>?</div>
                        <div class="options">
                            ${shuffled.map((opt, j) => `
                                <div class="option">
                                    <strong>${String.fromCharCode(65 + j)}.</strong> ${opt}
                                </div>
                            `).join('')}
                        </div>
                        ${interactiveMode ? `
                            <div style="margin-top: 12px;">
                                <label style="font-weight: bold; color: #4a5568; font-size: 14px;">Your Answer:</label>
                                <input type="text" 
                                       class="answer-input" 
                                       placeholder="Enter A, B, C, or D"
                                       maxlength="1"
                                       data-question="${13 + i}"
                                       value="${studentAnswers['q' + (13 + i)] || ''}"
                                       oninput="this.value = this.value.toUpperCase(); saveAnswer('q' + (13 + i), this.value)">
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            html += `<p style="margin: 30px 0 20px 0;"><strong>Section B: Context Clues</strong></p>`;

            for (let i = 7; i < 10; i++) {
                const word = vocab[i];
                const options = [word.word, vocab[(i + 1) % vocab.length].word, vocab[(i + 2) % vocab.length].word, vocab[(i + 3) % vocab.length].word];
                const shuffled = options.sort(() => Math.random() - 0.5);
                const correctIdx = shuffled.indexOf(word.word);
                
                currentTest.answers.vocabulary[13 + i] = String.fromCharCode(65 + correctIdx);

                html += `
                    <div class="question">
                        <div class="question-number">Question ${13 + i}.</div>
                        <div class="question-text">Choose the word that best completes the sentence:<br>
                        <em>${word.context.replace('_______', '_______')}</em></div>
                        <div class="options">
                            ${shuffled.map((opt, j) => `
                                <div class="option">
                                    <strong>${String.fromCharCode(65 + j)}.</strong> ${opt}
                                </div>
                            `).join('')}
                        </div>
                        ${interactiveMode ? `
                            <div style="margin-top: 12px;">
                                <label style="font-weight: bold; color: #4a5568; font-size: 14px;">Your Answer:</label>
                                <input type="text" 
                                       class="answer-input" 
                                       placeholder="Enter A, B, C, or D"
                                       maxlength="1"
                                       data-question="${13 + i}"
                                       value="${studentAnswers['q' + (13 + i)] || ''}"
                                       oninput="this.value = this.value.toUpperCase(); saveAnswer('q' + (13 + i), this.value)">
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            html += `<p style="margin: 30px 0 20px 0;"><strong>Section C: Prefixes and Word Usage</strong></p>`;

            for (let i = 0; i < 2; i++) {
                const word = vocab[i];
                const prefixInfo = word.prefix !== "None" ? word.prefix : "This word does not have a common prefix";
                
                html += `
                    <div class="question">
                        <div class="question-number">Question ${23 + i}.</div>
                        <div class="question-text">The word <span class="vocab-word">${word.word}</span> has the prefix: <strong>${prefixInfo}</strong><br>
                        Write a sentence using the word <span class="vocab-word">${word.word}</span> that demonstrates you understand its meaning.</div>
                        ${interactiveMode ? `
                            <textarea class="answer-textarea" 
                                      placeholder="Write your sentence here..."
                                      data-question="${23 + i}"
                                      style="min-height: 80px;"
                                      oninput="saveAnswer('q' + (23 + i), this.value)">${studentAnswers['q' + (23 + i)] || ''}</textarea>
                        ` : '<div class="writing-space"></div>'}
                    </div>
                `;
            }

            html += `
                <div class="question">
                    <div class="question-number">Question 27.</div>
                    <div class="question-text">Choose THREE vocabulary words from this test and write an original paragraph (4-5 sentences) that uses all three words correctly. Underline the vocabulary words in your paragraph.</div>
                    ${interactiveMode ? `
                        <textarea class="answer-textarea" 
                                  placeholder="Write your paragraph here using three vocabulary words..."
                                  data-question="27"
                                  style="min-height: 150px;"
                                  oninput="saveAnswer('q27', this.value)">${studentAnswers['q27'] || ''}</textarea>
                    ` : '<div class="writing-lines" style="min-height: 120px;"></div>'}
                </div>
            `;

            html += `</div>`;

            return html;
        }

        function renderAnswerKey() {
            let html = `
                <div class="answer-key">
                    <h2>📋 ANSWER KEY - FOR TEACHER USE ONLY</h2>
                    
                    <div class="answer-section">
                        <h3>Part I: Plot Elements</h3>
            `;

            for (let i = 1; i <= 5; i++) {
                html += `
                    <div class="answer-item">
                        <span class="answer-number">Question ${i}:</span>
                        <span class="correct-answer">${currentTest.answers.plotElements[i]}</span>
                    </div>
                `;
            }

            html += `
                        <div class="answer-item">
                            <span class="answer-number">Question 6:</span>
                            <span style="color: #4a5568;">Short answer - Look for character growth/change with specific examples from the story</span>
                        </div>
                    </div>

                    <div class="answer-section">
                        <h3>Part II: Poetry Analysis</h3>
            `;

            for (let i = 7; i <= 10; i++) {
                html += `
                    <div class="answer-item">
                        <span class="answer-number">Question ${i}:</span>
                        <span class="correct-answer">${currentTest.answers.poetry[i]}</span>
                    </div>
                `;
            }

            html += `
                        <div class="answer-item">
                            <span class="answer-number">Question 11:</span>
                            <span style="color: #4a5568;">Short answer - Student should identify a literary device with correct line citation and explanation</span>
                        </div>
                        <div class="answer-item">
                            <span class="answer-number">Question 12:</span>
                            <span style="color: #4a5568;">Short answer - Look for understanding of theme with textual evidence</span>
                        </div>
                    </div>

                    <div class="answer-section">
                        <h3>Part III: Vocabulary</h3>
                        <p style="margin-bottom: 10px;"><strong>Section A & B (Multiple Choice):</strong></p>
            `;

            for (let i = 13; i <= 22; i++) {
                html += `
                    <div class="answer-item">
                        <span class="answer-number">Question ${i}:</span>
                        <span class="correct-answer">${currentTest.answers.vocabulary[i]}</span>
                    </div>
                `;
            }

            html += `
                        <p style="margin: 15px 0 10px 0;"><strong>Section C (Written Responses):</strong></p>
                        <div class="answer-item">
                            <span class="answer-number">Questions 23-24:</span>
                            <span style="color: #4a5568;">Sentences should correctly use vocabulary words in context</span>
                        </div>
                        <div class="answer-item">
                            <span class="answer-number">Question 27:</span>
                            <span style="color: #4a5568;">Paragraph should coherently use three vocabulary words with correct meanings</span>
                        </div>
                    </div>

                    <div style="margin-top: 25px; padding: 15px; background: white; border-radius: 5px;">
                        <h4 style="margin-bottom: 10px;">Grading Rubric Suggestion:</h4>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Multiple Choice (20 questions × 2 points):</strong> 40 points</li>
                            <li><strong>Short Answers (4 questions × 5 points):</strong> 20 points</li>
                            <li><strong>Paragraph Writing (1 × 10 points):</strong> 10 points</li>
                            <li><strong>Total:</strong> 70 points</li>
                        </ul>
                    </div>
                </div>
            `;

            return html;
        }

        function printTest() {
            window.print();
        }

        function toggleAnswerKey() {
            showAnswerKey = !showAnswerKey;
            if (currentTest) {
                renderTest();
            } else {
                alert('Please generate a test first!');
            }
        }

        // NEW: Toggle interactive mode
        function toggleInteractiveMode() {
            interactiveMode = !interactiveMode;
            if (currentTest) {
                renderTest();
            }
        }

        // NEW: Save answer to storage
        function saveAnswer(questionId, answer) {
            studentAnswers[questionId] = answer;
            // Auto-save to localStorage as backup
            localStorage.setItem('ela_test_answers', JSON.stringify(studentAnswers));
        }

        // NEW: Load saved answers from localStorage
        function loadSavedAnswers() {
            const saved = localStorage.getItem('ela_test_answers');
            if (saved) {
                try {
                    studentAnswers = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading saved answers:', e);
                }
            }
        }

        // NEW: Clear all answers
        function clearAnswers() {
            if (confirm('Are you sure you want to clear all your answers?')) {
                studentAnswers = {};
                localStorage.removeItem('ela_test_answers');
                renderTest();
            }
        }

        // NEW: Submit answers for AI analysis
        async function submitForAnalysis() {
            // Check if student has answered questions
            const answerCount = Object.keys(studentAnswers).length;
            if (answerCount === 0) {
                alert('Please answer some questions before submitting!');
                return;
            }

            if (!confirm(`Submit ${answerCount} answers for AI analysis? This will cost about $0.03-0.04.`)) {
                return;
            }

            // Show loading state
            document.getElementById('testContent').innerHTML = `
                <div class="loading">
                    <h2>🤖 AI is analyzing your answers...</h2>
                    <p>Reviewing your work and preparing detailed feedback</p>
                    <div class="spinner"></div>
                    <p style="margin-top: 20px; font-size: 14px; color: #718096;">This takes about 20-40 seconds</p>
                </div>
            `;

            try {
                // Prepare test content for analysis
                const testContent = {
                    story: currentTest.story,
                    poem: currentTest.poem,
                    vocabulary: currentTest.vocabulary
                };

                // Call analysis API
                const response = await fetch('/.netlify/functions/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        studentAnswers: studentAnswers,
                        testContent: testContent
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Analysis failed: ${errorData.error || 'Unknown error'}`);
                }

                const result = await response.json();
                const analysis = result.analysis;

                // Display feedback
                displayFeedback(analysis);

                // Clear saved answers after successful submission
                localStorage.removeItem('ela_test_answers');

            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('testContent').innerHTML = `
                    <div class="loading">
                        <h2 style="color: #e53e3e;">❌ Error Analyzing Answers</h2>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p style="margin-top: 15px;">Make sure you've deployed the analysis function to Vercel.</p>
                        <button onclick="renderTest()" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Back to Test</button>
                    </div>
                `;
            }
        }

        // NEW: Display AI feedback
        function displayFeedback(analysis) {
            const letterGradeColors = {
                'A': '#22c55e',
                'B': '#3b82f6',
                'C': '#f59e0b',
                'D': '#f97316',
                'F': '#ef4444'
            };

            const gradeColor = letterGradeColors[analysis.letterGrade] || '#667eea';

            let html = `
                <div class="feedback-container">
                    <div class="score-summary">
                        <h2>Your Score</h2>
                        <div class="letter-grade" style="color: white;">${analysis.letterGrade}</div>
                        <p style="font-size: 24px; margin-bottom: 10px;">${analysis.overallScore} / ${analysis.maxScore} points</p>
                        <p style="font-size: 18px;">${analysis.percentageScore}%</p>
                    </div>

                    <div class="section-scores">
                        <div class="section-score-card">
                            <h3>📚 Plot Elements</h3>
                            <div class="score">${analysis.sectionScores.plotElements.score}/${analysis.sectionScores.plotElements.maxScore}</div>
                            <p style="margin-top: 10px; color: #4a5568;">${analysis.sectionScores.plotElements.feedback}</p>
                        </div>
                        <div class="section-score-card">
                            <h3>📝 Poetry Analysis</h3>
                            <div class="score">${analysis.sectionScores.poetry.score}/${analysis.sectionScores.poetry.maxScore}</div>
                            <p style="margin-top: 10px; color: #4a5568;">${analysis.sectionScores.poetry.feedback}</p>
                        </div>
                        <div class="section-score-card">
                            <h3>📖 Vocabulary</h3>
                            <div class="score">${analysis.sectionScores.vocabulary.score}/${analysis.sectionScores.vocabulary.maxScore}</div>
                            <p style="margin-top: 10px; color: #4a5568;">${analysis.sectionScores.vocabulary.feedback}</p>
                        </div>
                    </div>

                    <h2 style="margin-bottom: 20px; color: #2d3748;">📋 Detailed Question Feedback</h2>
            `;

            // Add feedback for each question
            analysis.questionFeedback.forEach(qf => {
                const statusClass = qf.isCorrect ? 'correct' : (qf.pointsEarned > 0 ? 'partial' : 'incorrect');
                const icon = qf.isCorrect ? '✅' : (qf.pointsEarned > 0 ? '⚠️' : '❌');
                const statusText = qf.isCorrect ? 'CORRECT' : (qf.pointsEarned > 0 ? 'PARTIALLY CORRECT' : 'INCORRECT');

                html += `
                    <div class="question-feedback ${statusClass}">
                        <div class="feedback-header">
                            <span class="feedback-icon">${icon}</span>
                            <div>
                                <div class="feedback-title">Question ${qf.questionNumber}: ${statusText}</div>
                                <div style="color: #4a5568; font-size: 14px; margin-top: 5px;">${qf.section} • ${qf.pointsEarned}/${qf.pointsPossible} points</div>
                            </div>
                        </div>

                        <div class="feedback-content">
                            ${qf.studentAnswer ? `
                                <div class="feedback-section">
                                    <h4>Your Answer</h4>
                                    <p><strong>${qf.studentAnswer}</strong></p>
                                </div>
                            ` : ''}

                            ${qf.correctAnswer ? `
                                <div class="feedback-section">
                                    <h4>Correct Answer</h4>
                                    <p><strong>${qf.correctAnswer}</strong></p>
                                </div>
                            ` : ''}

                            <div class="feedback-section">
                                <h4>💡 Feedback</h4>
                                <p>${qf.feedback}</p>
                            </div>

                            ${qf.contextClues ? `
                                <div class="feedback-section">
                                    <h4>🔍 Context Clues</h4>
                                    <p>${qf.contextClues}</p>
                                </div>
                            ` : ''}

                            ${qf.reasoning ? `
                                <div class="feedback-section">
                                    <h4>🎯 Why This Answer</h4>
                                    <p>${qf.reasoning}</p>
                                </div>
                            ` : ''}

                            ${qf.improvement ? `
                                <div class="feedback-section">
                                    <h4>📈 How to Improve</h4>
                                    <p>${qf.improvement}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            // Add overall feedback
            html += `
                <div class="overall-feedback">
                    <h3>🎓 Overall Feedback</h3>

                    ${analysis.overallFeedback.strengths && analysis.overallFeedback.strengths.length > 0 ? `
                        <h4 style="color: #22c55e; margin-top: 20px;">✨ Strengths</h4>
                        <ul>
                            ${analysis.overallFeedback.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    ` : ''}

                    ${analysis.overallFeedback.areasForGrowth && analysis.overallFeedback.areasForGrowth.length > 0 ? `
                        <h4 style="color: #f59e0b; margin-top: 20px;">🎯 Areas for Growth</h4>
                        <ul>
                            ${analysis.overallFeedback.areasForGrowth.map(a => `<li>${a}</li>`).join('')}
                        </ul>
                    ` : ''}

                    ${analysis.overallFeedback.studyTips && analysis.overallFeedback.studyTips.length > 0 ? `
                        <h4 style="color: #3b82f6; margin-top: 20px;">📚 Study Tips</h4>
                        <ul>
                            ${analysis.overallFeedback.studyTips.map(t => `<li>${t}</li>`).join('')}
                        </ul>
                    ` : ''}

                    ${analysis.overallFeedback.encouragement ? `
                        <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 6px; border-left: 4px solid ${gradeColor};">
                            <h4 style="margin-bottom: 10px;">💪 Keep It Up!</h4>
                            <p><em>${analysis.overallFeedback.encouragement}</em></p>
                        </div>
                    ` : ''}
                </div>

                <div style="text-align: center; margin-top: 30px; padding: 20px;">
                    <button onclick="generateTest()" class="generate-btn" style="margin-right: 10px;">📝 Try Another Test</button>
                    <button onclick="renderTest()" class="print-btn">🔙 Back to Test</button>
                </div>
            `;

            html += `</div>`;

            document.getElementById('testContent').innerHTML = html;

            // Scroll to top to see results
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleAnswerKey() {
            showAnswerKey = !showAnswerKey;
            if (currentTest) {
                renderTest();
            } else {
                alert('Please generate a test first!');
            }
        }

        window.onload = generateTest;
    </script>
</body>
</html>
